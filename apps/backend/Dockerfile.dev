FROM node:20-alpine

WORKDIR /app

# pnpm 설치
RUN corepack enable && corepack prepare pnpm@9 --activate

# 루트 workspace 설정 복사
COPY pnpm-workspace.yaml package.json pnpm-lock.yaml* ./

# 모든 패키지의 package.json 복사 (의존성 해결용)
COPY apps/backend/package.json ./apps/backend/
COPY packages/shared/package.json ./packages/shared/

# 의존성 설치
RUN pnpm install --frozen-lockfile

# shared 패키지 소스 복사 및 빌드
COPY packages/shared/ ./packages/shared/
RUN pnpm --filter @msspbiz/shared build

# backend 소스 복사 (소스는 volume으로 마운트되지만 초기 빌드용)
COPY apps/backend/ ./apps/backend/

# 업로드 디렉토리 생성
RUN mkdir -p /app/uploads && chmod 777 /app/uploads

EXPOSE 4001

# 개발 서버 실행 (핫리로드 활성화)
CMD ["pnpm", "--filter", "@msspbiz/backend", "run", "start:dev"]
